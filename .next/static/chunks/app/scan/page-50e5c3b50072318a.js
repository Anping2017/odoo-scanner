(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[398],{0:function(e,t,r){Promise.resolve().then(r.bind(r,2209))},2209:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return d}});var n=r(7437),i=r(2265),l=r(9398),a=r(1274);function o(e){let{onDetected:t,highPrecision:r=!0}=e,o=(0,i.useRef)(null),d=(0,i.useRef)(null),c=(0,i.useRef)(null),s=(0,i.useRef)(null),u=(0,i.useRef)(null),f=(0,i.useRef)(null),h=(0,i.useRef)(!1),p=(0,i.useRef)(!1),g=(0,i.useRef)(null),v=(0,i.useRef)(!1),[y,m]=(0,i.useState)(""),[b,x]=(0,i.useState)(!1),[w,j]=(0,i.useState)(!1),[k,S]=(0,i.useState)(!1),[C,R]=(0,i.useState)(null),[_,T]=(0,i.useState)(1),[E,z]=(0,i.useState)(1),F=()=>{f.current&&cancelAnimationFrame(f.current),f.current=null},M=(0,i.useCallback)(()=>{try{var e;null===(e=s.current)||void 0===e||e.call(s)}catch(e){}s.current=null,F();try{if(u.current){try{u.current.applyConstraints({advanced:[{torch:!1}]})}catch(e){}u.current.stop()}}catch(e){}u.current=null,x(!1),j(!1),S(!1),R(null)},[]),I=(0,i.useCallback)(()=>{var e,t,r,n,i,l;let a=null===(r=o.current)||void 0===r?void 0:null===(t=r.srcObject)||void 0===t?void 0:null===(e=t.getVideoTracks)||void 0===e?void 0:e.call(t)[0];if(!a)return;u.current=a;let d=(null===(n=a.getCapabilities)||void 0===n?void 0:n.call(a))||{};d.torch&&x(!0),"number"==typeof d.zoom?(S(!0),T(d.zoom),z(d.zoom),R(d.zoom)):(null===(i=d.zoom)||void 0===i?void 0:i.min)!=null&&(null===(l=d.zoom)||void 0===l?void 0:l.max)!=null&&(S(!0),T(d.zoom.min),z(d.zoom.max),R(Math.max(1,d.zoom.min)))},[]),B=async()=>{if(!u.current||!b)return;let e=!w;try{await u.current.applyConstraints({advanced:[{torch:e}]}),j(e)}catch(e){}},D=async e=>{if(R(e),u.current&&k)try{await u.current.applyConstraints({advanced:[{zoom:e}]})}catch(e){}},N=(0,i.useCallback)(async()=>{if("function"!=typeof globalThis.BarcodeDetector)return!1;let e=[];try{var n,i;e=await (null===(n=(i=globalThis.BarcodeDetector).getSupportedFormats)||void 0===n?void 0:n.call(i))||[]}catch(e){}let l=["ean_13","ean_8","upc_a","upc_e","code_128","code_39","qr_code"].filter(t=>e.includes(t));if(!l.length)return!1;let a=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"},width:{ideal:r?2560:1280},height:{ideal:r?1440:720},advanced:[{focusMode:"continuous"}]},audio:!1}),c=o.current;if(c.srcObject=a,await c.play(),u.current=a.getVideoTracks()[0],I(),!d.current){let e=document.createElement("canvas");e.style.display="none",d.current=e,document.body.appendChild(e)}let v=d.current,y=v.getContext("2d",{willReadFrequently:!0}),m=new globalThis.BarcodeDetector({formats:l}),b=async()=>{if(h.current)return;let e=c.videoWidth,r=c.videoHeight;if(!e||!r){f.current=requestAnimationFrame(b);return}let n=Math.floor(.8*e),i=Math.floor(.45*r),l=Math.min(1600,2*n),a=Math.floor(l/n*i);v.width=l,v.height=a,y.imageSmoothingEnabled=!1,y.drawImage(c,Math.floor((e-n)/2),Math.floor((r-i)/2),n,i,0,0,l,a);try{var o;let e=await m.detect(v),r=null==e?void 0:null===(o=e[0])||void 0===o?void 0:o.rawValue;if(r){h.current=!0,M(),t(String(r));return}}catch(e){}p.current||(p.current=!0,setTimeout(()=>{k&&null!=C&&E>C&&D(Math.min(1.6*C,E))},1500)),f.current=requestAnimationFrame(b)};return g.current="native",b(),s.current=()=>{a&&a.getTracks().forEach(e=>e.stop()),F()},!0},[D,k,r,I,t,M,C,E]),O=(0,i.useCallback)(async()=>{var e,n;let i=new Map;i.set(a.DecodeHintType.TRY_HARDER,!0),i.set(a.DecodeHintType.POSSIBLE_FORMATS,[a.BarcodeFormat.EAN_13,a.BarcodeFormat.EAN_8,a.BarcodeFormat.UPC_A,a.BarcodeFormat.UPC_E,a.BarcodeFormat.CODE_128,a.BarcodeFormat.CODE_39,a.BarcodeFormat.QR_CODE]),c.current||(c.current=new l.VJ(i));let d=r?{width:{ideal:2560},height:{ideal:1440}}:{width:{ideal:1280},height:{ideal:720}},f=o.current,p=await c.current.decodeFromConstraints({video:{facingMode:{ideal:"environment"},...d,advanced:[{focusMode:"continuous"}]},audio:!1},f,e=>{var r,n,i;e&&!h.current&&(h.current=!0,M(),t(null!==(i=null!==(n=null===(r=e.getText)||void 0===r?void 0:r.call(e))&&void 0!==n?n:e.text)&&void 0!==i?i:""))}),v=null===(n=f.srcObject)||void 0===n?void 0:null===(e=n.getVideoTracks)||void 0===e?void 0:e.call(n)[0];return v&&(u.current=v,I()),s.current=()=>p.stop(),g.current="zxing",!0},[r,I,t,M]),q=(0,i.useCallback)(async()=>{try{if(m(""),h.current=!1,p.current=!1,await N())return;await O()}catch(t){let e=String((null==t?void 0:t.message)||t);"https:"!==location.protocol&&"localhost"!==location.hostname?m("需要 HTTPS 才能启用摄像头（请用 https 访问）。"):/NotAllowedError/i.test(e)?m("相机权限被拒绝，请在浏览器设置中允许使用相机。"):/OverconstrainedError|NotFoundError|DevicesNotFound/i.test(e)?m("未检测到可用摄像头。"):m("启动摄像头失败："+e)}},[N,O]);async function A(e){try{var t,r;let n=globalThis.BarcodeDetector;if("function"!=typeof n)return"";let i=await (null===(t=n.getSupportedFormats)||void 0===t?void 0:t.call(n))||[],l=["ean_13","ean_8","upc_a","upc_e","code_128","code_39","qr_code"].filter(e=>i.includes(e));if(!l.length)return"";let a=await new n({formats:l}).detect(e);return(null==a?void 0:null===(r=a[0])||void 0===r?void 0:r.rawValue)?String(a[0].rawValue):""}catch(e){return""}}async function P(e){try{let n;let i=URL.createObjectURL(e),a=new Image;a.decoding="sync",a.src=i,await new Promise((e,t)=>{a.onload=e,a.onerror=t}),c.current||(c.current=new l.VJ);try{n=await c.current.decodeFromImage(a)}catch(e){var t,r;n=await (null===(t=(r=c.current).decodeFromImageElement)||void 0===t?void 0:t.call(r,a))}return URL.revokeObjectURL(i),(null==n?void 0:n.getText)?n.getText():(null==n?void 0:n.text)||""}catch(e){return""}}async function H(){if(!v.current){v.current=!0;try{let e=null;if(u.current&&"function"==typeof globalThis.ImageCapture)try{let t=new globalThis.ImageCapture(u.current);e=await t.takePhoto()}catch(e){}if(!e){let t=o.current,r=t.videoWidth,n=t.videoHeight;if(!d.current){let e=document.createElement("canvas");e.style.display="none",d.current=e,document.body.appendChild(e)}let i=d.current,l=Math.max(1280,Math.min(2200,2.2*r)),a=l/Math.max(1,r),c=Math.round(n*a);i.width=l,i.height=c;let s=i.getContext("2d",{willReadFrequently:!0});s.imageSmoothingEnabled=!1,s.drawImage(t,0,0,r,n,0,0,l,c),e=await new Promise(e=>i.toBlob(t=>e(t),"image/jpeg",.95))}if(!e)throw Error("无法获取照片");let r=await createImageBitmap(e),n=await A(r);n||(n=await P(e)),n&&!h.current?(h.current=!0,M(),t(n)):alert("未识别到条码，请靠近/补光/保持条码平直后重试。")}catch(e){alert("拍照识别失败："+((null==e?void 0:e.message)||String(e)))}finally{v.current=!1}}}async function L(e){var r;let n=null===(r=e.target.files)||void 0===r?void 0:r[0];if(n&&!v.current){v.current=!0;try{let e=await createImageBitmap(n),r=await A(e);r||(r=await P(n)),r&&!h.current?(h.current=!0,M(),t(r)):alert("未识别到条码，请选择更清晰的照片重试。")}catch(e){alert("图片识别失败："+((null==e?void 0:e.message)||String(e)))}finally{e.target.value="",v.current=!1}}}(0,i.useEffect)(()=>{var e;if(!(null===(e=navigator.mediaDevices)||void 0===e?void 0:e.getUserMedia)){m("当前浏览器不支持摄像头 API");return}return q(),()=>{M()}},[q,M]),(0,i.useEffect)(()=>{let e=()=>{"visible"!==document.visibilityState||h.current||q()};return document.addEventListener("visibilitychange",e),()=>document.removeEventListener("visibilitychange",e)},[q]);let W={padding:"8px 12px",borderRadius:8,border:"1px solid #ddd",background:"#fff"};return(0,n.jsxs)("div",{style:{height:"100%",display:"flex",flexDirection:"column",gap:8},children:[(0,n.jsxs)("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[b&&(0,n.jsx)("button",{style:W,onClick:B,children:w?"关手电":"开手电"}),k&&null!==C&&(0,n.jsxs)("div",{style:{display:"flex",gap:6,alignItems:"center"},children:[(0,n.jsx)("span",{className:"small",children:"Zoom"}),(0,n.jsx)("input",{type:"range",min:_,max:E,step:.1,value:C,onChange:e=>D(Number(e.target.value)),style:{width:160}}),(0,n.jsxs)("span",{className:"small",children:[C.toFixed(1),"x"]})]}),(0,n.jsx)("button",{style:W,onClick:H,children:"拍照识别（高清）"}),(0,n.jsxs)("label",{style:{...W,cursor:"pointer",display:"inline-block"},children:["相册/拍照上传",(0,n.jsx)("input",{type:"file",accept:"image/*",capture:"environment",style:{display:"none"},onChange:L})]}),(0,n.jsxs)("span",{className:"small",style:{opacity:.7},children:["引擎：",g.current||"…"]})]}),(0,n.jsx)("div",{style:{position:"relative",flex:"1 1 0",minHeight:0,overflow:"hidden",borderRadius:12},children:(0,n.jsx)("video",{ref:o,muted:!0,playsInline:!0,autoPlay:!0,style:{position:"absolute",inset:0,width:"100%",height:"100%",objectFit:"cover",background:"#000"}})}),y&&(0,n.jsx)("div",{style:{color:"#dc2626",fontSize:12},children:y})]})}function d(){var e;let[t,r]=(0,i.useState)(!0),[l,a]=(0,i.useState)(!1),[d,c]=(0,i.useState)(""),[s,u]=(0,i.useState)(null),[f,h]=(0,i.useState)(""),[p,g]=(0,i.useState)(""),[v,y]=(0,i.useState)([]),[m,b]=(0,i.useState)(!1),x=(0,i.useRef)(!1),w=(0,i.useRef)(null),j=(0,i.useRef)(""),k=(0,i.useCallback)(async e=>{try{let t=await fetch("/api/inventory?product_id=".concat(e,"&limit=10"),{cache:"no-store"}),r=await t.json().catch(()=>({}));y(Array.isArray(null==r?void 0:r.history)?r.history:[])}catch(e){y([])}},[]),S=(0,i.useCallback)(async e=>{let t=e.trim();if(!t||x.current||j.current===t)return;x.current=!0,j.current=t,a(!0),w.current&&w.current.abort();let r=new AbortController;w.current=r;try{let e=await fetch("/api/product?code=".concat(encodeURIComponent(t)),{signal:r.signal,cache:"no-store"}),n=await e.json().catch(()=>({}));c(t);let i=(null==n?void 0:n.product)||null;u(i),g("number"==typeof(null==i?void 0:i.qty_available)?String(i.qty_available):""),(null==i?void 0:i.id)&&k(i.id)}finally{a(!1),x.current=!1}},[k]),C=(0,i.useCallback)(e=>{e&&(r(!1),h(e),S(e))},[S]),R=(0,i.useCallback)(()=>{u(null),c(""),h(""),g(""),y([]),j.current="",r(!0)},[]),_=(0,i.useCallback)(async()=>{try{await fetch("/api/logout",{method:"POST",credentials:"include"})}catch(e){}window.location.href="/"},[]),T=(0,i.useCallback)(e=>{e&&e.preventDefault();let t=f.trim();t&&(r(!1),S(t))},[f,S]),E=(0,i.useCallback)(()=>{u(null),c(""),h(""),g(""),y([]),j.current=""},[]),z=(0,i.useCallback)(async()=>{if(!(null==s?void 0:s.id))return;let e=Number(p);if(Number.isNaN(e)){alert("请输入正确的数量");return}b(!0);try{let t=await fetch("/api/inventory",{method:"POST",headers:{"Content-Type":"application/json"},cache:"no-store",body:JSON.stringify({product_id:s.id,new_qty:e})}),r=await t.json().catch(()=>({}));if(!t.ok||!(null==r?void 0:r.ok))throw Error((null==r?void 0:r.error)||"更新失败");j.current="",d&&await S(d),s.id&&await k(s.id),alert("库存已更新（Odoo 中已记录库存调整历史）。")}catch(e){alert((null==e?void 0:e.message)||"库存更新失败")}finally{b(!1)}},[null==s?void 0:s.id,p,d,S,k]);return(0,n.jsxs)("div",{style:{minHeight:"100dvh",display:"flex",flexDirection:"column",background:"#f8fafc",paddingBottom:92},children:[(0,n.jsxs)("div",{style:{position:"sticky",top:0,zIndex:10,background:"#fff",borderBottom:"1px solid #e5e7eb",display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px 14px"},children:[(0,n.jsx)("div",{style:{fontWeight:700},children:"库存扫码"}),(0,n.jsxs)("div",{style:{display:"flex",gap:8},children:[(0,n.jsx)("button",{onClick:R,style:{padding:"8px 12px",borderRadius:8,border:"1px solid #e5e7eb",background:"#fff"},children:"重新扫码"}),(0,n.jsx)("button",{onClick:_,style:{padding:"8px 12px",borderRadius:8,border:"1px solid #ef4444",background:"#fff",color:"#ef4444",fontWeight:600},children:"退出"})]})]}),(0,n.jsxs)("div",{style:{padding:12},children:[(0,n.jsx)("div",{style:{position:"relative",overflow:"hidden",borderRadius:12,background:"#000",height:"56vh"},children:t?(0,n.jsx)(o,{onDetected:C}):(0,n.jsx)("div",{style:{color:"#9ca3af",height:"100%",display:"grid",placeItems:"center",fontSize:14},children:"摄像头已暂停"})}),d?(0,n.jsxs)("div",{style:{marginTop:12,padding:12,background:"#fff",border:"1px solid #e5e7eb",borderRadius:10,fontSize:14},children:["最近条码：",(0,n.jsx)("strong",{children:d}),l?(0,n.jsx)("span",{style:{marginLeft:8,color:"#6b7280"},children:"查询中…"}):null]}):null,(0,n.jsxs)("div",{style:{marginTop:12,display:"grid",gap:12},children:[s?(0,n.jsxs)("div",{style:{background:"#fff",border:"1px solid #e5e7eb",borderRadius:12,padding:14,lineHeight:1.5},children:[(0,n.jsx)("div",{style:{fontWeight:700,fontSize:16,marginBottom:4},children:s.name}),(0,n.jsxs)("div",{style:{color:"#6b7280",fontSize:13},children:["条码：",s.barcode||"-"," | 编码：",s.default_code||"-"]}),(0,n.jsxs)("div",{style:{marginTop:8,fontSize:14},children:["现有库存：",(0,n.jsx)("strong",{children:null!==(e=s.qty_available)&&void 0!==e?e:"-"}),"number"==typeof s.free_qty?(0,n.jsxs)("span",{style:{marginLeft:10,color:"#6b7280"},children:["可用：",s.free_qty]}):null]}),(0,n.jsxs)("div",{style:{marginTop:12,display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[(0,n.jsx)("label",{style:{fontSize:14},children:"盘点数量（调整到）："}),(0,n.jsx)("input",{type:"number",inputMode:"decimal",value:p,onChange:e=>g(e.target.value),style:{width:140,padding:"8px 10px",borderRadius:8,border:"1px solid #e5e7eb",outline:"none",fontSize:16}}),(0,n.jsx)("button",{onClick:z,disabled:m,style:{padding:"10px 14px",borderRadius:10,border:"none",background:m?"#9ca3af":"#111827",color:"#fff",fontWeight:600},children:m?"更新中…":"更新库存"})]})]}):d&&!l?(0,n.jsxs)("div",{style:{background:"#fff",border:"1px solid #e5e7eb",borderRadius:12,padding:14,fontSize:14},children:["未找到产品（条码：",d,"）"]}):null,s?(0,n.jsxs)("div",{style:{background:"#fff",border:"1px solid #e5e7eb",borderRadius:12,padding:14},children:[(0,n.jsx)("div",{style:{fontWeight:700,marginBottom:8},children:"最近库存调整记录"}),v.length?(0,n.jsx)("div",{style:{display:"grid",gap:8},children:v.map(e=>(0,n.jsxs)("div",{style:{border:"1px solid #e5e7eb",borderRadius:10,padding:10,fontSize:13,lineHeight:1.5},children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("strong",{children:e.qty_done})," ",e.uom||""]}),(0,n.jsxs)("div",{style:{color:"#6b7280"},children:[e.from||"-"," → ",e.to||"-"]}),(0,n.jsxs)("div",{style:{color:"#6b7280"},children:[new Date(e.date).toLocaleString()," | ",e.created_by||e.updated_by||""]}),e.ref?(0,n.jsxs)("div",{style:{color:"#6b7280"},children:["Ref: ",e.ref]}):null]},e.id))}):(0,n.jsx)("div",{style:{color:"#6b7280",fontSize:13},children:"暂无记录"})]}):null]})]}),(0,n.jsxs)("form",{onSubmit:T,style:{position:"fixed",left:0,right:0,bottom:0,zIndex:20,background:"#fff",borderTop:"1px solid #e5e7eb",padding:"10px 12px calc(10px + env(safe-area-inset-bottom))",display:"flex",gap:8,alignItems:"center"},children:[(0,n.jsx)("input",{inputMode:"search",placeholder:"手动输入/粘贴条码",value:f,onChange:e=>h(e.target.value),style:{flex:1,padding:"12px 12px",borderRadius:10,border:"1px solid #e5e7eb",outline:"none",fontSize:16}}),(0,n.jsx)("button",{type:"submit",style:{padding:"12px 14px",borderRadius:10,border:"none",background:"#111827",color:"#fff",fontWeight:600},children:"查询"}),(0,n.jsx)("button",{type:"button",onClick:E,style:{padding:"12px 14px",borderRadius:10,border:"1px solid #e5e7eb",background:"#fff"},children:"清空"})]})]})}}},function(e){e.O(0,[505,971,117,744],function(){return e(e.s=0)}),_N_E=e.O()}]);