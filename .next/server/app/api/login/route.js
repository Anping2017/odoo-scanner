"use strict";(()=>{var e={};e.id=740,e.ids=[740],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},1271:(e,t,o)=>{o.r(t),o.d(t,{originalPathname:()=>m,patchFetch:()=>y,requestAsyncStorage:()=>l,routeModule:()=>u,serverHooks:()=>O,staticGenerationAsyncStorage:()=>h});var s={};o.r(s),o.d(s,{POST:()=>p});var n=o(9303),r=o(8716),a=o(670),i=o(7070),c=o(4405);async function d(e,t,o,s){let n=await fetch(`${e}${t}`,{method:"POST",headers:{"Content-Type":"application/json",...s?{cookie:s}:{}},body:JSON.stringify({jsonrpc:"2.0",id:Date.now(),method:"call",params:o})}),r=n.headers.get("set-cookie")||"";return{data:await n.json().catch(()=>({})),setCookie:r}}async function p(e){try{let{login:t,password:o,companyId:s,remember:n,baseUrl:r,dbName:a}=await e.json();if(!t||!o)return i.NextResponse.json({error:"缺少账号或密码"},{status:400});let p=e.headers.get("x-forwarded-host")||e.headers.get("host")||void 0,u=(0,c.jm)(p),l=r||u?.url,h=a||u?.db;if(!l||!h)return i.NextResponse.json({error:"Unknown host preset：请在 body 里提供 baseUrl/dbName，或设置 ODOO_URL/ODOO_DB 环境变量。"},{status:400});let{data:O,setCookie:m}=await d(l,"/web/session/authenticate",{db:h,login:t,password:o}),y=function(e,t){if(e?.result?.session_id)return e.result.session_id;let o=/(?:^|;\s*)session_id=([^;]+)/i.exec(t||"");return o?.[1]}(O,m);if(!y)return i.NextResponse.json({error:"认证失败：账号或密码错误"},{status:401});let b=m||`session_id=${y}`;s&&await fetch(`${l}/web/session/switch_company`,{method:"POST",headers:{"Content-Type":"application/json",cookie:b},body:JSON.stringify({jsonrpc:"2.0",id:Date.now(),method:"call",params:{company_id:Number(s)}})}).catch(()=>{});let f=i.NextResponse.json({ok:!0,base:l,db:h,companyId:s||null}),g=n?2592e3:void 0,_={path:"/",secure:!0,sameSite:"lax"};return f.cookies.set("od_session",y,{..._,httpOnly:!0,...g?{maxAge:g}:{}}),f.cookies.set("od_base",l,{..._,httpOnly:!1,...g?{maxAge:g}:{}}),f.cookies.set("od_db",h,{..._,httpOnly:!1,...g?{maxAge:g}:{}}),s&&f.cookies.set("od_company",String(s),{..._,httpOnly:!1,...g?{maxAge:g}:{}}),u?.defaultLocationId&&f.cookies.set("od_location",String(u.defaultLocationId),{..._,httpOnly:!1,...g?{maxAge:g}:{}}),f}catch(e){return i.NextResponse.json({error:e?.message||"登录失败"},{status:500})}}let u=new n.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/login/route",pathname:"/api/login",filename:"route",bundlePath:"app/api/login/route"},resolvedPagePath:"C:\\working\\next.js\\odoo-inventory-scanner\\app\\api\\login\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:l,staticGenerationAsyncStorage:h,serverHooks:O}=u,m="/api/login/route";function y(){return(0,a.patchFetch)({serverHooks:O,staticGenerationAsyncStorage:h})}},4405:(e,t,o)=>{o.d(t,{jm:()=>r});let s={"moboplus.co.nz":{url:"https://moboplus.co.nz",db:"odoo",defaultLocationId:1},"repair.raytech.co.nz":{url:"https://repair.raytech.co.nz",db:"db-raytech-repair",defaultLocationId:1}},n=process.env.ODOO_URL&&process.env.ODOO_DB?{url:process.env.ODOO_URL,db:process.env.ODOO_DB,defaultLocationId:Number(process.env.ODOO_LOCATION_ID||0)||void 0}:void 0;function r(e){let t=(e||"").toLowerCase().replace(/^www\./,"").split(":")[0];return t.endsWith("moboplus.co.nz")?s["moboplus.co.nz"]:t.endsWith("repair.raytech.co.nz")||"raytech.co.nz"===t?s["repair.raytech.co.nz"]:n}}};var t=require("../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),s=t.X(0,[276,972],()=>o(1271));module.exports=s})();